{% extends "boox_app/base.html" %} {% load static i18n %} {% block content %}
<div class="container mb-1">
  <form method="post" action="{% url 'book-creation' %}">
    {% csrf_token %}
    <div class="w-90 h-90 m-auto">

      <input type="hidden" name="cover" value="" id="cover">
      <div class="row mb-2 gy-1">
        <div class="col-sm-12 col-md-6 mb-sm-1 mb-md-0">
          <div
            class="w-100 h-100 d-flex justify-content-center px-2 {% if 'cover' in errors %} red-border red-hover-effect {% else %} purple-border purple-hover-effect {% endif %} grey-hover-effect"
            id="dropArea" onclick="performClick('fileElem');">
            <div class="vstack gap-3 m-auto d-flex align-items-center" id="dropAreaCenterDiv">
              <input type="file" id="fileElem" multiple accept="image/*" onchange="handleFiles(this.files)" style="display: none;">
              {% if 'cover' in errors %}
              <div class="h6 my-2" id="dropAreaText1">Cover is required</div>
              {% else %}
              <div class="h6 " id="dropAreaText2">Drop a picture of the cover here</div>
              {% endif %}
              <svg viewBox="0 0 100.4 100.4" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" width="150px" height="150px" id="bookSvg">
                <path
                d="m92.9 60.4-7.4-5v-15l7.4-4.9c.4-.3.7-.7.7-1.2s-.3-1-.7-1.2L54.8 7.5c-.5-.3-1.2-.3-1.7 0l-47 31.4c-.2.1-.3.2-.4.4v.1c-.2.3-.2.5-.2.8v27.5c0 .5.3 1 .7 1.2l38.1 25.4c.3.2.5.3.8.3.3 0 .6-.1.8-.3L93 62.9c.4-.3.7-.7.7-1.2-.1-.6-.4-1.1-.8-1.3zM54 10.6l35.4 23.6-5.8 3.8c-.3.1-.6.3-.8.5L45 63.7 16.6 44.8c-.1-.1-.2-.1-.2-.2l-6.8-4.5L54 10.6zM17.1 48.8l27 18c.5.3 1.2.3 1.7 0l36.7-24.5v12.3L45.2 79.2l-28.1-18V48.8zM45 91.2 8.4 66.8V43l5.8 3.8V62c0 .5.3 1 .7 1.3l29.6 19c.2.2.5.2.8.2.3 0 .6-.1.8-.2l37.4-24.6 5.9 4L45 91.2z"
                fill="{% if 'cover' in errors %}#dc3545{% else %}#563d7c{% endif %}" class="fill-000000" />
                <path
                d="m47.5 24.3 17.8 12.2c.3.2.6.3.8.3.5 0 .9-.2 1.2-.7.5-.7.3-1.6-.4-2.1L49.2 21.8c-.7-.5-1.6-.3-2.1.4s-.3 1.6.4 2.1z"
                fill="{% if 'cover' in errors %}#dc3545{% else %}#563d7c{% endif %}" class="fill-000000" />
              </svg>
            
              {% if not 'cover' in errors %}
              <div class="h6 " id="selectFile">Click here to select a file</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-6 d-flex">
          <div class="row ">
            <div class="col-12  mb-2 pb-1">
              <div class="">
                <label class="pb-1 fw-light text-start w-100">Title of the book</label>
                <input type="text" name="title" value="{{data.title}}"
                  class="form-control px-2  {% if 'title' in errors %} is-invalid {% endif %} needs-validation" id="title" />
              </div>
            </div>
            <div class="col-12 mt-2 py-2">
              <div class="">
                <label class="pb-1 fw-light text-start w-100">Author of the book</label>
                <input type="text" name="author_name" value="{{data.author_name}}"
                  class="form-control px-2  {% if 'author_name' in errors %} is-invalid {% endif %}" id="author_name"
                   />
              </div>
            </div>
            <div class="col-12 my-4 py-4"></div>
            <div class="col-12 my-1 py-1">
              <div class="">
                <label class="pb-1 fw-light text-start w-100">GoodReads link</label>
                <input type="text" name="goodreads" value="{{data.goodreads}}"
                  class="form-control px-2  {% if 'goodread' in errors %} is-invalid {% endif %}" id="goodreads" />
              </div>
            </div>
            <div class="col-12 my-1 py-1">
              <div class="">
                <!-- <input type="text" name="wilaya" class="form-control px-2  {% if 'wilaya' in errors %} is-invalid {% endif %}" id="floatingInput"/> -->
                <label class="pb-1 fw-light text-start w-100">Wilaya</label>
                <select name="wilaya" class="form-select {% if 'wilaya' in errors %} is-invalid {% endif %} "
                  aria-label="Floating label select wilaya" id="wilaya">
                  
                  {% if not data.wilaya or data.wilaya == "" %}
                  <option selected disabled></option>
                  {% endif%}
                  {% for region in regions %}
                  <option value="{{region.wilaya_code}}" {% if region.wilaya_code|stringformat:"s" == data.wilaya|stringformat:"s" %} selected {% endif %} >{{region.wilaya_code}} - {{region.wilaya_name_ascii}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-12 my-1 py-3">
              <span class="h5 py-2" >{% trans "Intrested buyers will contact you at" %}</span>
              <div class="row my-3 py-3">
                <div class="col-6"><a class="nav-link text-dark grey-hover-effect" href="{% url 'book-creation' %}">
                  <span class="mx-1">
                    <svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="34px" height="35px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x38_2-messenger"><g><g><path d="M256.002,16.75c-131.772,0-238.605,99.167-238.605,221.515     c0,69.709,34.688,131.886,88.908,172.497v84.487l81.244-44.712c21.684,6.007,44.648,9.27,68.453,9.27     c131.77,0,238.602-99.168,238.602-221.513C494.604,115.918,387.771,16.75,256.002,16.75L256.002,16.75z M256.002,16.75" style="fill:#1F8EEF;"/><path d="M279.711,315.062l-60.756-64.988l-118.552,64.988l130.394-138.823l62.244,64.988l117.094-64.988     L279.711,315.062z M279.711,315.062" style="fill:#FCFCFC;"/></g></g></g><g id="Layer_1"/></svg>
                  </span>
                  Messenger
                </a></div>
                <div class="col-6"><a class="nav-link text-dark grey-hover-effect" href="{% url 'book-creation' %}">
                  <span class="mx-1">
                    <svg style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="35px" height="35px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="_x33_75-whatsapp"><g><path d="M417.103,92.845C374.08,49.721,316.787,26.001,255.897,26.001    c-125.678,0-227.946,102.269-227.946,227.945c0,40.146,10.474,79.37,30.394,113.973l-32.343,118.08l120.852-31.728    c33.268,18.173,70.744,27.724,108.941,27.724h0.103c125.576,0,230.101-102.269,230.101-227.945    C485.998,193.161,460.125,135.97,417.103,92.845z" style="fill:#2CB742;"/><path d="M255.897,443.593c-34.089,0-67.46-9.138-96.518-26.388l-6.879-4.107l-71.67,18.789l19.099-69.924    l-4.518-7.187c-18.995-30.188-28.956-64.995-28.956-100.83c0-104.424,85.018-189.44,189.545-189.44    c50.619,0,98.158,19.714,133.892,55.548c35.731,35.835,57.705,83.376,57.603,133.996    C447.495,358.578,360.319,443.593,255.897,443.593z" style="fill:#FFFFFF;"/><path d="M359.807,301.691c-5.647-2.872-33.677-16.635-38.914-18.48c-5.237-1.952-9.035-2.875-12.834,2.875    s-14.683,18.48-18.073,22.384c-3.285,3.799-6.674,4.312-12.321,1.437c-33.473-16.735-55.445-29.878-77.521-67.768    c-5.853-10.062,5.854-9.344,16.736-31.11c1.85-3.801,0.926-7.086-0.514-9.961c-1.436-2.875-12.834-30.906-17.557-42.304    c-4.62-11.089-9.343-9.549-12.835-9.754c-3.285-0.206-7.086-0.206-10.883-0.206c-3.8,0-9.96,1.438-15.197,7.085    c-5.236,5.75-19.92,19.51-19.92,47.541s20.432,55.139,23.205,58.937c2.874,3.798,40.148,61.299,97.338,86.045    c36.144,15.607,50.314,16.94,68.386,14.271c10.985-1.643,33.679-13.759,38.401-27.107c4.723-13.347,4.723-24.743,3.285-27.105    C369.255,305.901,365.454,304.465,359.807,301.691z" style="fill:#2CB742;"/></g></g><g id="Layer_1"/></svg>
                  </span>
                  Whatsup
                </a></div>
              </div>
            </div>
            <div class="col-12 d-flex px-2 ">
              <label class=" w-25 h-100 d-flex justify-content-start align-items-center ">
                <span class="pb-2 text-start align-middle fw-light">Selling price</span>
              </label>
              <div class="w-75">
                <input type="number" name="price" value="{{data.price}}" class="form-control {% if 'price' in errors %} is-invalid {% endif %}"
                  id="price" />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="mt-2">
          <button class="col-12 btn btn-secondary py-3 my-1" type="submit">Post for sale</button>
        </div>
      </div>

    </div>
  </form>
</div>

<script>

  function updateSvgColor(svgElm, colorStr) {
    var children = svgElm.children;
    for (var i = 0; i < children.length; i++) {
      children[i].setAttribute("fill", colorStr);
    }
  }

  function setErrorCover(errorMsg) {
    dropArea.classList.remove("purple-border")
    dropArea.classList.add("red-border")

    var bookSvg = document.getElementById("bookSvg");
    updateSvgColor(bookSvg, "#563d7c");

    var dropAreaText = document.getElementById("dropAreaText");
    dropAreaText.innerHTML = errorMsg;
  }

  function unsetErrorCover(errorMsg) {
    dropArea.classList.add("purple-border")
    dropArea.classList.remove("red-border")

    var bookSvg = document.getElementById("bookSvg");
    updateSvgColor(bookSvg, "#563d7c");

    var dropAreaText = document.getElementById("dropAreaText");
    dropAreaText.innerHTML = "Done! Loading..";
  }

  function preventDefaults(e) {
    e.preventDefault()
    e.stopPropagation()
  }

  function highlight(e) {
    dropArea.classList.add('highlight')
    dropArea.classList.add('highlight-drop')
  }

  function unhighlight(e) {
    dropArea.classList.remove('highlight');
    dropArea.classList.remove('highlight-drop');
  }

  function activateLoading(){
    spinnerHtml = `<div class="d-flex justify-content-center">
        <div class="spinner- purple-text" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>`
    var dropAreaCenterDiv = document.getElementById('dropAreaCenterDiv');
    dropAreaCenterDiv.innerHTML = spinnerHtml
  }

  function handleDrop(e) {
    dropArea.classList.add("purple-border")
    dropArea.classList.remove("red-border")
    
    let dt = e.dataTransfer
    let files = dt.files

    handleFiles(files)
  }
  
  function handleFiles(files) {
    activateLoading();
    ([...files]).forEach(uploadFile)
  }

  function saveCoverInfo(data) {
    localStorage.setItem('coverName', data.file_name);
    localStorage.setItem('coverPath', data.file_path);
  }

  function setCoverImg(data) {
    var dropArea = document.getElementById('dropArea');
    dropArea.classList.remove("purple-border")
    dropArea.classList.remove("px-2");
    dropArea.classList.add("-purple-r5");
    dropArea.innerHTML = `
      <img class="w-100 h-100" src="${data.file_path}" />
    `;
  }

  function appendCoverInfoToForm(data) {
    var cover = document.getElementById('cover');
    cover.classList.add("-purple-r5")
    cover.value = data.file_path;
  }

  function uploadFile(file) {
    let url = "/books/cover/"
    let formData = new FormData()

    formData.append('file', file)

    fetch(url, {
      method: 'POST',
      body: formData
    })
      .then((response) => {
        if (response.status !== 200) {
          response.json().then(data => {
            setErrorCover(data.file)
          });
        }

        return response.json()
      })
      .then((data) => {
        saveCoverInfo(data);
        appendCoverInfoToForm(data);
        setCoverImg(data)
      })
      .catch((error) => {
        console.log(error.message)
      })
  }

  var dropArea = document.getElementById('dropArea');

  ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false)
  });

  ;['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false)
  });

  ;['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false)
  })

  dropArea.addEventListener('drop', handleDrop, false)



  function reValidate(){
    console.log(this.value)
    console.log(this.value && this.value !== '')

    if (this.value && this.value !== ''){
      this.classList.remove('is-invalid');
    }

    if (this.id === 'price'){
      if(Number.isFinite(Number.parseFloat(this.value))){
        this.classList.remove('is-invalid');
      }else{
        this.classList.add('is-invalid')
      }
    }
  }

  ;['title', 'author_name', 'goodreads', 'wilaya', 'price'].forEach(elmId => {
    var elm = document.getElementById(elmId);
    elm.oninput = reValidate;
  })

  function performClick(elemId) {
    var elem = document.getElementById(elemId);
    if(elem && document.createEvent) {
        var evt = document.createEvent("MouseEvents");
        evt.initEvent("click", false, false);
        elem.dispatchEvent(evt);
    }
  }

</script>
{% endblock %}